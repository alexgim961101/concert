# ì½˜ì„œíŠ¸ ì˜ˆì•½ ì„œë¹„ìŠ¤ (Concert Reservation Service)

ëŒ€ê¸°ì—´ ì‹œìŠ¤í…œê³¼ ë™ì‹œì„± ì œì–´ë¥¼ í†µí•´ ì•ˆì •ì ì¸ ì½˜ì„œíŠ¸ ì¢Œì„ ì˜ˆì•½ ë° ê²°ì œë¥¼ ì§€ì›í•˜ëŠ” ë°±ì—”ë“œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.

## ğŸ“– í”„ë¡œì íŠ¸ ì†Œê°œ
ì´ í”„ë¡œì íŠ¸ëŠ” ëŒ€ê·œëª¨ íŠ¸ë˜í”½ ìƒí™©ì—ì„œë„ ì•ˆì •ì ìœ¼ë¡œ ì½˜ì„œíŠ¸ ì¢Œì„ì„ ì˜ˆì•½í•  ìˆ˜ ìˆëŠ” ì‹œìŠ¤í…œì„ êµ¬í˜„í•˜ëŠ” ê²ƒì„ ëª©í‘œë¡œ í•©ë‹ˆë‹¤. **ëŒ€ê¸°ì—´ ì‹œìŠ¤í…œ(Queue)** ì„ í†µí•´ ìœ ëŸ‰ ì œì–´ë¥¼ ìˆ˜í–‰í•˜ê³ , **ì˜ˆì•½ ë° ê²°ì œ** ê³¼ì •ì—ì„œì˜ ë°ì´í„° ì¼ê´€ì„±ì„ ë³´ì¥í•©ë‹ˆë‹¤.

### ì£¼ìš” ê¸°ëŠ¥
*   **ëŒ€ê¸°ì—´ ì‹œìŠ¤í…œ**: Redisë¥¼ í™œìš©í•˜ì—¬ ëŒ€ê¸°ì—´ í† í° ë°œê¸‰ ë° ìˆœë²ˆ ê´€ë¦¬ (ìœ ëŸ‰ ì œì–´).
*   **ì½˜ì„œíŠ¸ ìŠ¤ì¼€ì¤„ë§**: ì½˜ì„œíŠ¸ ë‚ ì§œ ë° íšŒì°¨ë³„ ì¢Œì„ ê´€ë¦¬.
*   **ì¢Œì„ ì˜ˆì•½**: ë™ì‹œì„± ì œì–´ë¥¼ í†µí•œ ì„ì‹œ ë°°ì • (ì¢Œì„ ì„ ì ) ê¸°ëŠ¥.
*   **í¬ì¸íŠ¸ ë° ê²°ì œ**: í¬ì¸íŠ¸ ì¶©ì „ ë° ì˜ˆì•½ì„ ìœ„í•œ í¬ì¸íŠ¸ ê²°ì œ ê¸°ëŠ¥.

## ğŸ› ï¸ ê¸°ìˆ  ìŠ¤íƒ (Tech Stack)
*   **Language**: Java 21
*   **Framework**: Spring Boot 3.5.9
*   **Database**: MySQL 8.0
*   **Cache/Queue**: Redis
*   **Message Broker**: Kafka
*   **Build**: Gradle
*   **Container**: Docker & Docker Compose

## ğŸ“ ì„¤ê³„ ë° ì•„í‚¤í…ì²˜
ìƒì„¸í•œ ì„¤ê³„ ë¬¸ì„œëŠ” `docs/` ë””ë ‰í† ë¦¬ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
*   [**ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜**](docs/ARCHITECTURE.md): ì‹œìŠ¤í…œ êµ¬ì„± ìš”ì†Œ ë° ì„œë¹„ìŠ¤ íë¦„ë„.
*   [**DB ì„¤ê³„ (ERD)**](docs/ERD.md): ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ ë° ì—”í‹°í‹° ê´€ê³„.
*   [**API ëª…ì„¸ì„œ**](docs/API_SPEC.md): REST API ì—”ë“œí¬ì¸íŠ¸ ë° ìš”ì²­/ì‘ë‹µ ê·œê²©.

## ğŸš€ ì‹¤í–‰ ë°©ë²• (Getting Started)

### ì‚¬ì „ ìš”êµ¬ì‚¬í•­
*   Docker ë° Docker Composeê°€ ì„¤ì¹˜ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.

### Dockerë¡œ ì „ì²´ ì‹¤í–‰
ë‹¨ì¼ ëª…ë ¹ì–´ë¡œ ì „ì²´ ì¸í”„ë¼(MySQL, Redis, Kafka)ì™€ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```bash
# ë¹Œë“œ ë° ì‹¤í–‰
docker-compose up -d --build
```

### ì ‘ì† ì •ë³´
*   **API Server**: `http://localhost:8080`
*   **MySQL**: Port `3306`
*   **Redis**: Port `6379`
*   **Kafka**: Port `9092`

## ğŸ“… ì§„í–‰ ìƒí™© ë° ê³„íš
- [x] **ì¸í”„ë¼ êµ¬ì¶•**: Docker Compose (MySQL, Redis, Kafka) êµ¬ì„± ì™„ë£Œ.
- [x] **ì‹œìŠ¤í…œ ì„¤ê³„**: ERD, ì•„í‚¤í…ì²˜, API ëª…ì„¸ì„œ ì‘ì„± ì™„ë£Œ.
- [ ] **ê¸°ëŠ¥ êµ¬í˜„**:
    - [ ] ìœ ì € ë° í¬ì¸íŠ¸ ë„ë©”ì¸
    - [ ] ì½˜ì„œíŠ¸ ë° ì¢Œì„ ë„ë©”ì¸
    - [ ] ì˜ˆì•½ ë„ë©”ì¸
    - [ ] ê²°ì œ ë„ë©”ì¸
    - [ ] ëŒ€ê¸°ì—´ ì‹œìŠ¤í…œ (Token)
- [ ] **ë™ì‹œì„± ì œì–´**: ë¶„ì‚° ë½, ë‚™ê´€ì  ë½ ë“±ì„ í™œìš©í•œ ë™ì‹œì„± ì´ìŠˆ í•´ê²°.
- [ ] **í…ŒìŠ¤íŠ¸**: ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ë° í†µí•© í…ŒìŠ¤íŠ¸ ì‘ì„±.

## ğŸ”§ ë°ì´í„°ë² ì´ìŠ¤ ì¸ë±ìŠ¤ ìµœì í™”

ì¿¼ë¦¬ ì„±ëŠ¥ ê°œì„ ì„ ìœ„í•´ ë‹¤ìŒ ì¸ë±ìŠ¤ë¥¼ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.

### ì¶”ê°€ëœ ì¸ë±ìŠ¤

| í…Œì´ë¸” | ì¸ë±ìŠ¤ | ì»¬ëŸ¼ | ëŒ€ìƒ ì¿¼ë¦¬ |
|--------|--------|------|----------|
| `queue_tokens` | `idx_queue_tokens_status_id` | `(status, id)` | ëŒ€ê¸°ì—´ ìˆœìœ„ ê³„ì‚° |
| `seats` | `idx_seats_schedule_status` | `(schedule_id, status)` | ìŠ¤ì¼€ì¤„ë³„ ì¢Œì„ ì¡°íšŒ |
| `reservations` | `idx_reservations_status_expires` | `(status, expires_at)` | ë§Œë£Œ ì˜ˆì•½ ë°°ì¹˜ ì²˜ë¦¬ |
| `payments` | `idx_payments_user_id` | `(user_id)` | í–¥í›„ í™•ì¥ ëŒ€ë¹„* |
| `payments` | `idx_payments_reservation_id` | `(reservation_id)` | í–¥í›„ í™•ì¥ ëŒ€ë¹„* |

> *`payments` ì¸ë±ìŠ¤ëŠ” í˜„ì¬ ì‚¬ìš©ë˜ëŠ” ì¿¼ë¦¬ê°€ ì—†ì–´ ë²¤ì¹˜ë§ˆí¬ì— í¬í•¨ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. "ë‚´ ê²°ì œ ë‚´ì—­ ì¡°íšŒ", "ì˜ˆì•½ë³„ ê²°ì œ ì •ë³´ ì¡°íšŒ" ë“±ì˜ API ì¶”ê°€ ì‹œ í™œìš©ë©ë‹ˆë‹¤.

### ì¸ë±ìŠ¤ ì¶”ê°€ ì´ìœ 

1. **`queue_tokens`**: `countByStatusAndIdLessThan` ì¿¼ë¦¬ì—ì„œ Full Table Scan ë°©ì§€
2. **`seats`**: FK ì¸ë±ìŠ¤ë§Œìœ¼ë¡œëŠ” status í•„í„°ë§ ì‹œ ì¶”ê°€ ìŠ¤ìº” í•„ìš”, ë³µí•© ì¸ë±ìŠ¤ë¡œ Covering Index íš¨ê³¼
3. **`reservations`**: ë§Œë£Œ ì˜ˆì•½ ë°°ì¹˜ ì²˜ë¦¬ ì‹œ íš¨ìœ¨ì  ì¡°íšŒ
4. **`payments`**: í–¥í›„ ê²°ì œ ë‚´ì—­ ì¡°íšŒ API í™•ì¥ ëŒ€ë¹„

### ì„±ëŠ¥ ì¸¡ì • ê²°ê³¼

**í…ŒìŠ¤íŠ¸ ë°ì´í„° ê·œëª¨**: ì¢Œì„ 1,000,000ê°œ, ëŒ€ê¸°ì—´ í† í° 1,000,000ê°œ, ì˜ˆì•½ 500,000ê°œ

| Repository | ë©”ì„œë“œ | Baseline | Indexed | ë³€í™” |
|------------|--------|----------|---------|------|
| `SeatJpaRepository` | `countByScheduleIdAndStatus` | 150.9 ms | 0.29 ms | **-99.8%** ğŸ”¥ |
| `SeatJpaRepository` | `findByScheduleIdAndStatusIn` | 194.7 ms | 40.2 ms | **-79%** |
| `ReservationJpaRepository` | `findAllByStatusAndExpiresAtBefore` | 75.6 ms | 16.3 ms | **-78%** |

> **ì¸ë±ìŠ¤ íš¨ê³¼**: 100ë§Œ ê±´ ê·œëª¨ì—ì„œ í•µì‹¬ ì¿¼ë¦¬ê°€ **5~500ë°°** ë¹¨ë¼ì¡ŒìŠµë‹ˆë‹¤.

#### ì™œ `countByScheduleIdAndStatus`ê°€ 99.8% ê°œì„ ë˜ì—ˆë‚˜?

**Covering Index** íš¨ê³¼ ë•Œë¬¸ì…ë‹ˆë‹¤:

| ì¿¼ë¦¬ íƒ€ì… | ë°˜í™˜ | í…Œì´ë¸” ì ‘ê·¼ | ì„±ëŠ¥ ê°œì„  |
|-----------|------|-------------|-----------|
| `COUNT` ì¿¼ë¦¬ | ìˆ«ì 1ê°œ | âŒ ë¶ˆí•„ìš” | **ê·¹ì ** (99.8%) |
| `SELECT *` ì¿¼ë¦¬ | ê°ì²´ ë¦¬ìŠ¤íŠ¸ | âœ… í•„ìš” | ë†’ìŒ (78~79%) |

- `COUNT(*)` ì¿¼ë¦¬ëŠ” ì¸ë±ìŠ¤ `(schedule_id, status)`ë§Œìœ¼ë¡œ ê²°ê³¼ë¥¼ ë°˜í™˜ ê°€ëŠ¥
- ì¸ë±ìŠ¤ì— í•„ìš”í•œ ëª¨ë“  ë°ì´í„°ê°€ ìˆì–´ **í…Œì´ë¸” I/O ì™„ì „ ì œê±°**
- ë°˜ë©´ `SELECT *` ì¿¼ë¦¬ëŠ” ì¸ë±ìŠ¤ Lookup í›„ **í…Œì´ë¸”ì—ì„œ ì‹¤ì œ ë°ì´í„°ë¥¼ ì½ì–´ì•¼ í•¨**

### ë²¤ì¹˜ë§ˆí¬ ì‹¤í–‰ ë°©ë²•

```bash
./gradlew test --tests "*PerformanceBenchmarkTest*"
```

---

## ğŸ”’ ë™ì‹œì„± ì œì–´

### ë™ì‹œì„± ìœ„í—˜ ì§€ì  ë° í•´ê²° ë°©ì‹

| ìœ„í—˜ ì§€ì  | UseCase | ë¬¸ì œ ì‹œë‚˜ë¦¬ì˜¤ | í•´ê²° ë°©ì‹ |
|-----------|---------|---------------|-----------|
| **ì¢Œì„ ì˜ˆì•½** | `ReserveSeatUseCase` | ë™ì‹œì— ê°™ì€ ì¢Œì„ ì˜ˆì•½ â†’ ì¤‘ë³µ ì˜ˆì•½ | **Redis ë¶„ì‚° ë½ (Redisson)** |
| **í¬ì¸íŠ¸ ì¶©ì „** | `ChargePointUseCase` | ë™ì‹œ ì¶©ì „ â†’ ì¼ë¶€ ëˆ„ë½ | DB ë‚™ê´€ì  ë½ (`@Version`) |
| **í¬ì¸íŠ¸ ì‚¬ìš©** | `UsePointUseCase` | ë™ì‹œ ì‚¬ìš© â†’ ì”ì•¡ ë¶ˆì¼ì¹˜ | DB ë‚™ê´€ì  ë½ (`@Version`) |
| **ê²°ì œ ì²˜ë¦¬** | `ProcessPaymentUseCase` | ì¤‘ë³µ ê²°ì œ | ì˜ˆì•½ ë¹„ê´€ì  ë½ |

---

### ë™ì‹œì„± ì œì–´ ë°©ë²• ë¹„êµ

| ë°©ì‹ | ì„¤ëª… | ì¥ì  | ë‹¨ì  | ì í•©í•œ ìƒí™© |
|------|------|------|------|-------------|
| **DB ë¹„ê´€ì  ë½** | `SELECT ... FOR UPDATE`ë¡œ í–‰ ì ê¸ˆ | ì¶©ëŒ ì™„ì „ ë°©ì§€, ì¦‰ì‹œ ëŒ€ê¸° | ì„±ëŠ¥ ì €í•˜, ë°ë“œë½ ê°€ëŠ¥ | ì¶©ëŒ ë¹ˆë„ ë†’ìŒ, ë°ì´í„° ì •í•©ì„± í•„ìˆ˜ |
| **DB ë‚™ê´€ì  ë½** | `@Version` í•„ë“œë¡œ ë³€ê²½ ê°ì§€ | ì„±ëŠ¥ ìš°ìˆ˜, ë°ë“œë½ ì—†ìŒ | ì¶©ëŒ ì‹œ ì¬ì‹œë„ í•„ìš” | ì¶©ëŒ ë¹ˆë„ ë‚®ìŒ, ì½ê¸° ìœ„ì£¼ |
| **Redis ë¶„ì‚° ë½** | Redisson/Lettuceë¡œ ë¶„ì‚° ì ê¸ˆ | DB ë¶€í•˜ ë¶„ì‚°, í™•ì¥ì„± | Redis ì˜ì¡´ì„±, TTL ê´€ë¦¬ í•„ìš” | ì™¸ë¶€ API ì œí•œ, ë¶„ì‚° ìºì‹œ ë™ê¸°í™” |
| **Application ë½** | `synchronized` / `ReentrantLock` | êµ¬í˜„ ê°„ë‹¨ | ë‹¨ì¼ ì¸ìŠ¤í„´ìŠ¤ì—ì„œë§Œ ìœ íš¨ | ë‹¨ì¼ ì„œë²„, ì¸ë©”ëª¨ë¦¬ ì‘ì—… |
| **DB Unique ì œì•½** | `UNIQUE INDEX`ë¡œ ì¤‘ë³µ ë°©ì§€ | ê°€ì¥ ê°„ë‹¨, DB ë ˆë²¨ ë³´ì¥ | ì‚¬í›„ ë°©ì–´ë§Œ ê°€ëŠ¥ | ì¤‘ë³µ ì‚½ì… ë°©ì§€ (ì˜ˆ: 1ì¸ 1ì˜ˆì•½) |

---

### ì„ íƒ ì´ìœ 

#### ì¢Œì„ ì˜ˆì•½: **Redis ë¶„ì‚° ë½** ì„ íƒ

```
âŒ ë‚™ê´€ì  ë½: ì¸ê¸° ì¢Œì„ì€ ì¶©ëŒ ë¹ˆë„ê°€ ë§¤ìš° ë†’ì•„ ì¬ì‹œë„ê°€ ë°˜ë³µë¨
âŒ DB ë¹„ê´€ì  ë½: ëŒ€ê¸° ì‹œ DB ì»¤ë„¥ì…˜ì„ ì ìœ í•˜ì—¬ ì»¤ë„¥ì…˜ í’€ ê³ ê°ˆ ìœ„í—˜
âœ… Redis ë¶„ì‚° ë½: DB ë¶€í•˜ ë¶„ì‚°, ì»¤ë„¥ì…˜ í’€ ë³´í˜¸, ë¹ ë¥¸ ì‹¤íŒ¨ ì²˜ë¦¬
```

**ì„ íƒ ê·¼ê±°:**
- ì½˜ì„œíŠ¸ í‹°ì¼“íŒ…ì€ íŠ¹ì„±ìƒ **ë™ì¼ ìì›(ì¢Œì„)ì— ëŒ€í•œ ê²½ìŸì´ ë§¤ìš° ë†’ìŒ**
- DB ë¹„ê´€ì  ë½ ì‚¬ìš© ì‹œ **ìˆ˜ë°± ê°œì˜ íŠ¸ëœì­ì…˜ì´ DB ì»¤ë„¥ì…˜ì„ ì ìœ í•˜ë©° ëŒ€ê¸°** â†’ ì»¤ë„¥ì…˜ í’€ ê³ ê°ˆ ìœ„í—˜
- Redis ë¶„ì‚° ë½ìœ¼ë¡œ **ë½ íšë“í•œ ìš”ì²­ë§Œ DBì— ì ‘ê·¼** â†’ DB ë¶€í•˜ ê°ì†Œ
- `@DistributedLock` ì»¤ìŠ¤í…€ ì–´ë…¸í…Œì´ì…˜ + AOPë¡œ **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ê³¼ ë½ ë¡œì§ ë¶„ë¦¬`

#### í¬ì¸íŠ¸ ì¶©ì „/ì‚¬ìš©: **ë‚™ê´€ì  ë½** ì„ íƒ

```
âŒ ë¹„ê´€ì  ë½: ì‚¬ìš©ìë³„ í¬ì¸íŠ¸ëŠ” ì¶©ëŒ í™•ë¥ ì´ ë‚®ì•„ ë½ ì˜¤ë²„í—¤ë“œ ë°œìƒ
âŒ Redis ë¶„ì‚° ë½: ê³¼ë„í•œ ì¸í”„ë¼ ë³µì¡ë„ ì¶”ê°€
âœ… ë‚™ê´€ì  ë½: ì¶©ëŒ ë°œìƒ ì‹œì—ë§Œ ì˜ˆì™¸ ì²˜ë¦¬, í‰ì†Œì—ëŠ” ë½ ì˜¤ë²„í—¤ë“œ ì—†ìŒ
```

**ì„ íƒ ê·¼ê±°:**
- í¬ì¸íŠ¸ëŠ” **ì‚¬ìš©ìë³„ë¡œ ë…ë¦½ì ** â†’ ê°™ì€ ì‚¬ìš©ìê°€ ë™ì‹œì— ì¶©ì „/ì‚¬ìš©í•˜ëŠ” ê²½ìš°ë§Œ ì¶©ëŒ
- ì¼ë°˜ì ìœ¼ë¡œ ì¶©ëŒ í™•ë¥ ì´ ë‚®ì•„ **ëŒ€ë¶€ë¶„ì˜ ìš”ì²­ì´ ë½ ì˜¤ë²„í—¤ë“œ ì—†ì´ ì„±ê³µ**
- ê¸°ì¡´ `@Version` í•„ë“œê°€ ì´ë¯¸ ì¡´ì¬í•˜ì—¬ ë³„ë„ ì¸í”„ë¼ í•„ìš” ì—†ìŒ
- ì¶©ëŒ ì‹œ `ConcurrencyConflictException`ìœ¼ë¡œ í´ë¼ì´ì–¸íŠ¸ì— ì¬ì‹œë„ ìœ ë„ (HTTP 409)

#### ì™œ Redis ë¶„ì‚° ë½ì„ ì„ íƒí–ˆë‚˜?

| ê¸°ì¤€ | DB ë¹„ê´€ì  ë½ (ì´ì „) | Redis ë¶„ì‚° ë½ (í˜„ì¬) |
|------|---------------------|----------------------|
| DB ë¶€í•˜ | ë½ ëŒ€ê¸° ì‹œ ì»¤ë„¥ì…˜ ì ìœ  | DB ì ‘ê·¼ ìµœì†Œí™” |
| ì²˜ë¦¬ëŸ‰ | ë‚®ìŒ | ë†’ìŒ (ë©”ëª¨ë¦¬ ê¸°ë°˜) |
| í™•ì¥ì„± | DB ë½ ì²˜ë¦¬ëŸ‰ í•œê³„ | ìˆ˜í‰ í™•ì¥ ìš©ì´ |
| ë³µì¡ë„ | ê°„ë‹¨ (`@Lock` ì‚¬ìš©) | AOP ê¸°ë°˜ êµ¬í˜„ í•„ìš” |

**ë³€ê²½ ì´ìœ :**
- ëŒ€ê·œëª¨ íŠ¸ë˜í”½ ì‹œ **DB ì»¤ë„¥ì…˜ í’€ ê³ ê°ˆ ìœ„í—˜ ë°©ì§€**
- ë½ íšë“ ì‹¤íŒ¨ ì‹œ **ë¹ ë¥¸ ì‹¤íŒ¨ ì²˜ë¦¬ (Fail Fast)**ë¡œ ì‚¬ìš©ì ê²½í—˜ ê°œì„ 
- Redisê°€ ì´ë¯¸ ëŒ€ê¸°ì—´ ì‹œìŠ¤í…œì— ì‚¬ìš© ì¤‘ì´ë¯€ë¡œ **ì¶”ê°€ ì¸í”„ë¼ ë¹„ìš© ì—†ìŒ**

---

### ë‹¤ì¤‘ ì¸ìŠ¤í„´ìŠ¤ í™˜ê²½

**DB ë½ì€ ë‹¤ì¤‘ ì¸ìŠ¤í„´ìŠ¤(Scale-out)ì—ì„œ ì •ìƒ ì‘ë™í•©ë‹ˆë‹¤:**

```
Instance A: SELECT ... FOR UPDATE (seat_id=1) â†’ ë½ íšë“ âœ…
Instance B: SELECT ... FOR UPDATE (seat_id=1) â†’ ëŒ€ê¸° ì¤‘... â³
Instance A: COMMIT â†’ ë½ í•´ì œ
Instance B: ë½ íšë“ â†’ ì¢Œì„ ì´ë¯¸ ì˜ˆì•½ë¨ â†’ ì‹¤íŒ¨
```

DB ë½ì€ **ë°ì´í„°ë² ì´ìŠ¤ ë ˆë²¨**ì—ì„œ ê´€ë¦¬ë˜ë¯€ë¡œ, ì–´ë–¤ ì¸ìŠ¤í„´ìŠ¤ì—ì„œ ìš”ì²­ì´ ë“¤ì–´ì™€ë„ ì¼ê´€ëœ ë™ì‹œì„± ì œì–´ê°€ ë³´ì¥ë©ë‹ˆë‹¤.

---

### ë™ì‹œì„± í…ŒìŠ¤íŠ¸ ì‹¤í–‰

```bash
./gradlew test --tests "*ConcurrencyIntegrationTest*"
```

---

## ğŸš€ ìºì‹± ì „ëµ (Caching Strategy)

### ì™œ ìºì‹±ì´ í•„ìš”í•œê°€?

ì½˜ì„œíŠ¸ ì˜ˆì•½ ì„œë¹„ìŠ¤ëŠ” **í‹°ì¼“ ì˜¤í”ˆ ì‹œì ì— ìˆ˜ì²œ ëª…ì´ ë™ì‹œ ì¡°íšŒ**í•˜ëŠ” íŠ¹ì„±ì´ ìˆìŠµë‹ˆë‹¤. ìŠ¤ì¼€ì¤„ ì¡°íšŒ, ê°€ìš© ì¢Œì„ ìˆ˜ ê³„ì‚° ë“±ì˜ ì¿¼ë¦¬ê°€ ë§¤ë²ˆ DBë¥¼ ë•Œë¦¬ë©´ ê³¼ë¶€í•˜ê°€ ë°œìƒí•©ë‹ˆë‹¤.

### ì™œ Redisì¸ê°€?

| ê¸°ì¤€ | Redis | Local Cache (Caffeine ë“±) |
|------|-------|---------------------------|
| ë‹¤ì¤‘ ì¸ìŠ¤í„´ìŠ¤ | âœ… ê³µìœ  ìºì‹œ | âŒ ì¸ìŠ¤í„´ìŠ¤ë³„ ë³„ë„ |
| ë°ì´í„° ì¼ê´€ì„± | âœ… ì¤‘ì•™ ê´€ë¦¬ | âŒ ë™ê¸°í™” í•„ìš” |
| ê¸°ì¡´ ì¸í”„ë¼ | âœ… ì´ë¯¸ ì‚¬ìš© ì¤‘ (ëŒ€ê¸°ì—´) | - |
| ì„±ëŠ¥ | O(1) ì¡°íšŒ | O(1) ì¡°íšŒ |

â†’ **ì´ë¯¸ Redis ì¸í”„ë¼ê°€ ìˆê³ , Scale-out í™˜ê²½ì—ì„œ ìºì‹œ ì¼ê´€ì„±ì´ ì¤‘ìš”**í•˜ë¯€ë¡œ Redis ì„ íƒ.

### ì ìš© ë°©ì‹

| ëŒ€ìƒ | TTL | ì „ëµ |
|------|-----|------|
| **ì½˜ì„œíŠ¸ ìŠ¤ì¼€ì¤„ + ê°€ìš© ì¢Œì„ ìˆ˜** | 5ë¶„ Â± 30ì´ˆ | ì½ê¸° ì‹œ ìºì‹±, ì¬ì¡°íšŒ ì‹œ ìºì‹œ íˆíŠ¸ |
| **ì¢Œì„ ëª©ë¡** | 30ì´ˆ Â± 5ì´ˆ | ì˜ˆì•½ ì„±ê³µ ì‹œ Write-Throughë¡œ ì¦‰ì‹œ ê°±ì‹  |

**í•µì‹¬ ì„¤ê³„:**
- **TTL Jitter**: ìºì‹œ ë§Œë£Œ ì‹œê°„ì— ëœë¤ ê°’ ì¶”ê°€ â†’ Cache Avalanche ë°©ì§€
- **Cache Stampede ë°©ì§€**: `sync = true` ì˜µì…˜ìœ¼ë¡œ ë™ì¼ í‚¤ì— ëŒ€í•´ í•œ ìŠ¤ë ˆë“œë§Œ DB ì¡°íšŒ
- **Write-Through**: ì¢Œì„ ì˜ˆì•½ ì‹œ ìºì‹œ ì‚­ì œ ëŒ€ì‹  ê°±ì‹  â†’ Eviction Stampede ë°©ì§€
- **ìºì‹œ ì›œì—…**: ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ì‹œ 7ì¼ ë‚´ ì„ë°• ì½˜ì„œíŠ¸ ë¯¸ë¦¬ ìºì‹±

### ì„±ëŠ¥ ê°œì„  (ì‹¤ì¸¡)

100ë§Œê±´ ë°ì´í„° ê¸°ì¤€ ë²¤ì¹˜ë§ˆí¬ ê²°ê³¼:

| ì‹œë‚˜ë¦¬ì˜¤ | ì‘ë‹µ ì‹œê°„ | ë¹„ê³  |
|----------|----------|------|
| **Cache Miss (DB ì¡°íšŒ)** | 6.48 ms | ìŠ¤ì¼€ì¤„ ì¡°íšŒ + ì¢Œì„ COUNT ì¿¼ë¦¬ |
| **Cache Hit (Redis ì¡°íšŒ)** | 0.33 ms | ì§ë ¬í™”ëœ ê²°ê³¼ ë°˜í™˜ |
| **ì„±ëŠ¥ ê°œì„ ìœ¨** | **94.9%** | |
| **ì†ë„ í–¥ìƒ** | **19.6ë°°** | |

### ë²¤ì¹˜ë§ˆí¬ ì‹¤í–‰

```bash
./gradlew test --tests "*CachePerformanceBenchmarkTest*" -Dorg.gradle.jvmargs="-Xmx4g"
```

> Docker + Redisê°€ í•„ìš”í•©ë‹ˆë‹¤. ì‹¤ì œ ê²°ê³¼ëŠ” í™˜ê²½ì— ë”°ë¼ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

---

## ğŸ”„ ëŒ€ê¸°ì—´ ì‹œìŠ¤í…œ (Queue System)

ì½˜ì„œíŠ¸ í‹°ì¼“íŒ… íŠ¸ë˜í”½ í­ì£¼ ìƒí™©ì—ì„œ **ìœ ëŸ‰ ì œì–´**ë¥¼ ìœ„í•œ ëŒ€ê¸°ì—´ ì‹œìŠ¤í…œì…ë‹ˆë‹¤.

### ì™œ Redisì¸ê°€? (vs DB vs MQ)

| ê¸°ì¤€ | DB (MySQL) | MQ (Kafka) | **Redis (ì„ íƒ)** |
|------|------------|------------|------------------|
| **ìˆœìœ„ ì¡°íšŒ** | âŒ `COUNT(*)` O(N) | âŒ ì˜¤í”„ì…‹ ê¸°ë°˜, ì‹¤ì‹œê°„ ë¶ˆê°€ | âœ… `ZRANK` O(log N) |
| **ì‹¤ì‹œê°„ ìˆœìœ„ ë³€ë™** | âŒ ë§¤ë²ˆ ì¬ê³„ì‚° í•„ìš” | âŒ ìˆœì„œ ë³´ì¥ë§Œ, ìˆœìœ„ ê°œë… ì—†ìŒ | âœ… ZSET ìë™ ì •ë ¬ |
| **í† í° ìƒíƒœ ê´€ë¦¬** | âœ… CRUD ìš©ì´ | âŒ ë©”ì‹œì§€ ìˆ˜ì • ë¶ˆê°€ | âœ… HASHë¡œ ë©”íƒ€ë°ì´í„° ê´€ë¦¬ |
| **í™œì„±í™” ì²˜ë¦¬** | âœ… UPDATE | âŒ Consumer êµ¬ì¡°ì™€ ë§ì§€ ì•ŠìŒ | âœ… ZREM + SADD ì›ìì  |
| **í™•ì¥ì„±** | ì¤‘ê°„ | ë†’ìŒ | ë†’ìŒ |

**ì„ íƒ ì´ìœ :**
- ëŒ€ê¸°ì—´ì˜ í•µì‹¬ ê¸°ëŠ¥ì€ **"ë‚´ ì•ì— ëª‡ ëª…?"** â†’ `ZRANK` O(log N)ì´ ê²°ì •ì 
- KafkaëŠ” Consumer ëª¨ë¸ì´ë¼ **ì‹¤ì‹œê°„ ìˆœìœ„ ì¡°íšŒ ë¶ˆê°€** (ì˜¤í”„ì…‹ â‰  ìˆœìœ„)
- MySQLì€ 100ë§Œ ê±´ ê¸°ì¤€ `COUNT(*)` ì¿¼ë¦¬ê°€ **ìˆ˜ë°± ms** ì†Œìš”

---

### Redis ë°ì´í„° êµ¬ì¡°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ queue:waiting:{concertId}  [ZSET]                          â”‚
â”‚   ìš©ë„: ëŒ€ê¸°ì—´ ìˆœì„œ ê´€ë¦¬ (score = ë“±ë¡ timestamp)            â”‚
â”‚   ì˜ˆì‹œ: {"abc-123": 1706444400000, "def-456": 1706444401000}â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ queue:active:{concertId}  [SET]                            â”‚
â”‚   ìš©ë„: í™œì„±í™”ëœ í† í° ì§‘í•© (ì…ì¥ í—ˆìš©ëœ ì‚¬ìš©ì)              â”‚
â”‚   ì˜ˆì‹œ: {"ghi-789", "jkl-012"}                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ queue:token:{token}  [HASH]                                â”‚
â”‚   ìš©ë„: í† í° ë©”íƒ€ë°ì´í„° (userId, status, expiresAt ë“±)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### í† í° ë°œê¸‰ íë¦„

```
ì‚¬ìš©ì ìš”ì²­ â†’ í™œì„± ìŠ¬ë¡¯ í™•ì¸ (SCARD) 
                    â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â–¼                     â–¼
    ìŠ¬ë¡¯ ì—¬ìœ  ìˆìŒ           ìŠ¬ë¡¯ ì—†ìŒ
         â”‚                     â”‚
         â–¼                     â–¼
   ACTIVE ìƒíƒœë¡œ ì €ì¥      WAITING ìƒíƒœë¡œ ì €ì¥
   (SADD active SET)       (ZADD waiting ZSET)
         â”‚                     â”‚
         â–¼                     â–¼
   rank=0, ì¦‰ì‹œ ì…ì¥      ZRANKë¡œ ìˆœìœ„ ë°˜í™˜
```

**ìŠ¤ì¼€ì¤„ëŸ¬ (1ì´ˆë§ˆë‹¤):** WAITING â†’ ACTIVE ì „í™˜
```
KEYS queue:waiting:* â†’ ê° ì½˜ì„œíŠ¸ë³„ ë¹ˆ ìŠ¬ë¡¯ í™•ì¸ â†’ ZPOPMINìœ¼ë¡œ ìƒìœ„ Nê°œ í™œì„±í™”
```

---

### ì„±ëŠ¥ ë¹„êµ

| ì—°ì‚° | MySQL | Redis |
|------|-------|-------|
| ìˆœìœ„ ì¡°íšŒ | O(N) `COUNT(*)` | **O(log N)** `ZRANK` |
| ìƒìœ„ Nê°œ ì¡°íšŒ | O(N log N) | **O(log N + M)** `ZRANGE` |
| í† í° ì €ì¥ | O(log N) INSERT | **O(log N)** `ZADD` |

**100ë§Œ ê±´ ê¸°ì¤€:** MySQL ìˆœìœ„ ì¡°íšŒ ~150ms â†’ Redis ~0.1ms (**1500ë°° ê°œì„ **)

---

### ì˜ì†ì„± ì„¤ì •

Redis ì¬ì‹œì‘ ì‹œ ë°ì´í„° ìœ ì‹¤ ë°©ì§€ë¥¼ ìœ„í•´ **AOF** ì˜ì†ì„± ì„¤ì •:

```conf
# docker/redis/redis.conf
appendonly yes
appendfsync everysec  # ìµœì•…ì˜ ê²½ìš° 1ì´ˆ ë°ì´í„°ë§Œ ìœ ì‹¤
```

---

## ğŸ“¨ ì´ë²¤íŠ¸ ê¸°ë°˜ ì•„í‚¤í…ì²˜ (Event-Driven Architecture)

ê²°ì œ ì™„ë£Œ í›„ ëŒ€ê¸°ì—´ í† í° ë§Œë£Œ ë“±ì˜ **ë„ë©”ì¸ ê°„ ì‘ì—…ì„ ë¹„ë™ê¸° ì´ë²¤íŠ¸ë¡œ ë¶„ë¦¬**í•˜ì—¬ ì„œë¹„ìŠ¤ ê°„ ê²°í•©ë„ë¥¼ ë‚®ì¶”ì—ˆìŠµë‹ˆë‹¤.

### ì™œ ì´ë²¤íŠ¸ ê¸°ë°˜ ì•„í‚¤í…ì²˜ì¸ê°€?

#### ê¸°ì¡´ ë¬¸ì œì  (ë™ê¸° í˜¸ì¶œ)

```java
// ProcessPaymentUseCase.java (Before)
public PaymentResult execute(...) {
    // 1. ê²°ì œ ì²˜ë¦¬
    paymentRepository.save(payment);
    
    // 2. ì˜ˆì•½ í™•ì •
    reservationRepository.save(reservation);
    
    // 3. í† í° ë§Œë£Œ â† ì—¬ê¸°ì„œ Queue ë„ë©”ì¸ ì§ì ‘ í˜¸ì¶œ!
    queueToken.expire();
    queueTokenRepository.save(queueToken);  // âŒ ê°•ê²°í•©
}
```

| ë¬¸ì œ | ì„¤ëª… |
|------|------|
| **ê°•ê²°í•©** | Payment ë„ë©”ì¸ì´ Queue ë„ë©”ì¸ì— ì§ì ‘ ì˜ì¡´ |
| **ë‹¨ì¼ ì¥ì• ì ** | Queue ì„œë¹„ìŠ¤ ì¥ì•  ì‹œ ê²°ì œë„ ì‹¤íŒ¨ |
| **í™•ì¥ì„± í•œê³„** | ê²°ì œ í›„ ì•Œë¦¼, ë¶„ì„ ë“± ì¶”ê°€ ì‹œ UseCase ë¹„ëŒ€í™” |
| **íŠ¸ëœì­ì…˜ ë²”ìœ„** | í† í° ë§Œë£Œê¹Œì§€ í•˜ë‚˜ì˜ DB íŠ¸ëœì­ì…˜ â†’ ë½ ì ìœ  ì‹œê°„ ì¦ê°€ |

#### ê°œì„ ëœ êµ¬ì¡° (ì´ë²¤íŠ¸ ê¸°ë°˜)

```java
// ProcessPaymentUseCase.java (After)
public PaymentResult execute(...) {
    // 1. ê²°ì œ ì²˜ë¦¬
    paymentRepository.save(payment);
    
    // 2. ì˜ˆì•½ í™•ì •
    reservationRepository.save(reservation);
    
    // 3. ê²°ì œ ì™„ë£Œ ì´ë²¤íŠ¸ ë°œí–‰ â† ëŠìŠ¨í•œ ê²°í•©!
    paymentEventPublisher.publishPaymentCompleted(event);  // âœ… ë¹„ë™ê¸°
}
```

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Payment       â”‚      â”‚     Kafka       â”‚      â”‚     Queue       â”‚
â”‚   Domain        â”‚â”€â”€â”€â”€â”€â–¶â”‚   (Broker)      â”‚â”€â”€â”€â”€â”€â–¶â”‚   Domain        â”‚
â”‚                 â”‚      â”‚                 â”‚      â”‚                 â”‚
â”‚ paymentEvent    â”‚      â”‚ payment-        â”‚      â”‚ PaymentCompletedâ”‚
â”‚ Publisher       â”‚      â”‚ completed       â”‚      â”‚ Consumer        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

| ê°œì„ ì  | ì„¤ëª… |
|--------|------|
| **ëŠìŠ¨í•œ ê²°í•©** | Payment â†’ Kafka ë°œí–‰ë§Œ, Queue ë„ë©”ì¸ ë¬´ì§€ |
| **ì¥ì•  ê²©ë¦¬** | Queue ì¥ì•  ì‹œì—ë„ ê²°ì œëŠ” ì •ìƒ ì™„ë£Œ |
| **í™•ì¥ì„±** | ìƒˆ Consumer ì¶”ê°€ë§Œìœ¼ë¡œ ê¸°ëŠ¥ í™•ì¥ (ì•Œë¦¼, ë¶„ì„ ë“±) |
| **íŠ¸ëœì­ì…˜ ë¶„ë¦¬** | ê²°ì œ íŠ¸ëœì­ì…˜ ë¹ ë¥´ê²Œ ì™„ë£Œ, í›„ì† ì‘ì—…ì€ ë¹„ë™ê¸° |

---

### ì™œ Kafkaì¸ê°€?

| ê¸°ì¤€ | RabbitMQ | Redis Pub/Sub | **Kafka (ì„ íƒ)** |
|------|----------|---------------|------------------|
| **ë©”ì‹œì§€ ì˜ì†ì„±** | ì„¤ì • í•„ìš” | âŒ ì—†ìŒ | âœ… ë””ìŠ¤í¬ ì €ì¥ |
| **ì¬ìƒ (Replay)** | âŒ ë¶ˆê°€ | âŒ ë¶ˆê°€ | âœ… ì˜¤í”„ì…‹ ê¸°ë°˜ ì¬ìƒ |
| **ì²˜ë¦¬ëŸ‰** | ì¤‘ê°„ | ë†’ìŒ | **ë§¤ìš° ë†’ìŒ** |
| **Consumer ì¥ì•  ë³µêµ¬** | ì œí•œì  | âŒ ë©”ì‹œì§€ ìœ ì‹¤ | âœ… Consumer Group ì˜¤í”„ì…‹ |
| **ê¸°ì¡´ ì¸í”„ë¼** | ì¶”ê°€ í•„ìš” | ìˆìŒ | **ì´ë¯¸ ìˆìŒ** (docker-compose) |
| **Dead Letter Queue** | ì§€ì› | ì§ì ‘ êµ¬í˜„ | âœ… ë„¤ì´í‹°ë¸Œ ì§€ì› |

**ì„ íƒ ì´ìœ :**
1. **ê³ ì²˜ë¦¬ëŸ‰**: í‹°ì¼“íŒ… ì˜¤í”ˆ ì‹œ ì´ˆë‹¹ ìˆ˜ì²œ ê±´ì˜ ê²°ì œ ì´ë²¤íŠ¸ ì²˜ë¦¬ í•„ìš”
2. **ë©”ì‹œì§€ ì˜ì†ì„±**: ì¥ì•  ì‹œì—ë„ ë©”ì‹œì§€ ìœ ì‹¤ ì—†ì´ ë³µêµ¬ ê°€ëŠ¥
3. **ì¬ìƒ ê°€ëŠ¥**: ë²„ê·¸ ë°œìƒ ì‹œ ì˜¤í”„ì…‹ ë¦¬ì…‹ìœ¼ë¡œ ì´ë²¤íŠ¸ ì¬ì²˜ë¦¬ ê°€ëŠ¥
4. **ê¸°ì¡´ ì¸í”„ë¼**: docker-composeì— ì´ë¯¸ Kafka í¬í•¨

---

### Kafka ë™ì‘ ì›ë¦¬

```
â”Œâ”€ Producer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  OutboxPublisher.publishPendingEvents()                           â”‚
â”‚  â†“                                                                â”‚
â”‚  KafkaTemplate.send("payment-completed", paymentId, eventJson)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€ Kafka Broker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Topic: payment-completed                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Partition 0                                                   â”‚ â”‚
â”‚  â”‚  [msg1] [msg2] [msg3] [msg4] [msg5] ...                      â”‚ â”‚
â”‚  â”‚         â†‘                                                     â”‚ â”‚
â”‚  â”‚    offset=2 (Consumer A)                                      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                   â”‚
â”‚  Topic: payment-completed.DLT (Dead Letter Topic)                 â”‚
â”‚  â”” ì²˜ë¦¬ ì‹¤íŒ¨ ë©”ì‹œì§€ ì €ì¥                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€ Consumer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PaymentCompletedConsumer.handlePaymentCompleted(message)         â”‚
â”‚  â†“                                                                â”‚
â”‚  1. JSON â†’ PaymentCompletedEvent ì—­ì§ë ¬í™”                         â”‚
â”‚  2. queueToken.expire() ì‹¤í–‰                                      â”‚
â”‚  3. acknowledgment.acknowledge() â† ìˆ˜ë™ ACK                       â”‚
â”‚                                                                   â”‚
â”‚  ì‹¤íŒ¨ ì‹œ: 3íšŒ ì¬ì‹œë„ â†’ DLT ì´ë™                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**í•µì‹¬ ê°œë…:**
- **Producer**: ë©”ì‹œì§€ ë°œí–‰ì (OutboxPublisher)
- **Topic**: ë©”ì‹œì§€ ì¹´í…Œê³ ë¦¬ (`payment-completed`)
- **Partition**: Topicì˜ ë¬¼ë¦¬ì  ë¶„í•  (ë³‘ë ¬ ì²˜ë¦¬ìš©)
- **Consumer Group**: ë™ì¼ ê·¸ë£¹ ë‚´ ConsumerëŠ” íŒŒí‹°ì…˜ ë¶„ë‹´
- **Offset**: ë©”ì‹œì§€ ìœ„ì¹˜, Consumerê°€ ì–´ë””ê¹Œì§€ ì½ì—ˆëŠ”ì§€ ì¶”ì 
- **Dead Letter Topic (.DLT)**: ì²˜ë¦¬ ì‹¤íŒ¨ ë©”ì‹œì§€ ì €ì¥ì†Œ

---

### Transactional Outbox íŒ¨í„´

#### ì™œ í•„ìš”í•œê°€?

**ë¬¸ì œ: ì´ì¤‘ ì“°ê¸° (Dual Write)**

```java
// âŒ ìœ„í—˜í•œ ì½”ë“œ
@Transactional
public void processPayment() {
    paymentRepository.save(payment);  // 1. DB ì €ì¥ âœ…
    kafkaTemplate.send("payment-completed", event);  // 2. Kafka ë°œí–‰
    // ë§Œì•½ ì—¬ê¸°ì„œ ì•±ì´ í¬ë˜ì‹œë˜ë©´?
    // â†’ DBì—ëŠ” ì €ì¥ëì§€ë§Œ Kafkaì—ëŠ” ë°œí–‰ ì•ˆ ë¨!
}
```

| ì‹œë‚˜ë¦¬ì˜¤ | DB ì €ì¥ | Kafka ë°œí–‰ | ê²°ê³¼ |
|----------|---------|------------|------|
| ì •ìƒ | âœ… | âœ… | ì •ìƒ |
| Kafka ë°œí–‰ í›„ í¬ë˜ì‹œ | âœ… | âœ… | ì •ìƒ |
| DB ì €ì¥ í›„, Kafka ë°œí–‰ ì „ í¬ë˜ì‹œ | âœ… | âŒ | **ë°ì´í„° ë¶ˆì¼ì¹˜!** |
| Kafka ë°œí–‰ ì„±ê³µ, DB ì»¤ë°‹ ì‹¤íŒ¨ | âŒ | âœ… | **ë°ì´í„° ë¶ˆì¼ì¹˜!** |

#### í•´ê²°: Transactional Outbox

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ + ì´ë²¤íŠ¸ ì €ì¥ (ë‹¨ì¼ íŠ¸ëœì­ì…˜)                  â”‚
â”‚                                                                     â”‚
â”‚   @Transactional                                                    â”‚
â”‚   public void processPayment() {                                    â”‚
â”‚       paymentRepository.save(payment);      // DB í…Œì´ë¸”            â”‚
â”‚       outboxRepository.save(outboxEvent);   // Outbox í…Œì´ë¸”        â”‚
â”‚   }  // â† í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ì›ìì  ì»¤ë°‹                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 2: Outbox Publisher (ìŠ¤ì¼€ì¤„ëŸ¬, 1ì´ˆë§ˆë‹¤)                        â”‚
â”‚                                                                     â”‚
â”‚   @Scheduled(fixedDelay = 1000)                                     â”‚
â”‚   public void publishPendingEvents() {                              â”‚
â”‚       List<OutboxEvent> events = outboxRepository                   â”‚
â”‚           .findTop100ByStatusOrderByCreatedAtAsc(PENDING);          â”‚
â”‚                                                                     â”‚
â”‚       for (OutboxEvent event : events) {                            â”‚
â”‚           kafkaTemplate.send(event.getTopic(), event.getPayload()); â”‚
â”‚           event.markAsPublished();                                  â”‚
â”‚           outboxRepository.save(event);                             â”‚
â”‚       }                                                             â”‚
â”‚   }                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### êµ¬í˜„ëœ íŒŒì¼

| íŒŒì¼ | ì—­í•  |
|------|------|
| `OutboxEvent.java` | Outbox í…Œì´ë¸” JPA ì—”í‹°í‹° |
| `OutboxEventStatus.java` | ìƒíƒœ Enum (PENDING, PUBLISHED, FAILED) |
| `OutboxEventRepository.java` | Outbox ì¡°íšŒ/ì €ì¥ |
| `OutboxPublisher.java` | ìŠ¤ì¼€ì¤„ëŸ¬ë¡œ PENDING ì´ë²¤íŠ¸ ë°œí–‰ |
| `PaymentEventPublisher.java` | ê²°ì œ ì´ë²¤íŠ¸ â†’ Outbox ì €ì¥ |
| `PaymentCompletedConsumer.java` | Kafka Consumer, í† í° ë§Œë£Œ ì²˜ë¦¬ |

#### Outbox í…Œì´ë¸” êµ¬ì¡°

```sql
CREATE TABLE outbox_events (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    aggregate_type VARCHAR(255) NOT NULL,    -- ì˜ˆ: "Payment"
    aggregate_id VARCHAR(255) NOT NULL,      -- ì˜ˆ: ê²°ì œ ID
    event_type VARCHAR(255) NOT NULL,        -- ì˜ˆ: "PaymentCompleted"
    topic VARCHAR(255) NOT NULL,             -- ì˜ˆ: "payment-completed"
    payload TEXT NOT NULL,                   -- JSON ì§ë ¬í™”ëœ ì´ë²¤íŠ¸
    status ENUM('PENDING','PUBLISHED','FAILED') NOT NULL,
    created_at DATETIME NOT NULL,
    published_at DATETIME,
    retry_count INT DEFAULT 0,
    last_error TEXT,
    
    INDEX idx_outbox_status (status),
    INDEX idx_outbox_created_at (created_at)
);
```

---

### Dead Letter Queue (DLQ)

ì²˜ë¦¬ ì‹¤íŒ¨ ë©”ì‹œì§€ë¥¼ ë³„ë„ í† í”½ìœ¼ë¡œ ì´ë™ì‹œì¼œ ë©”ì¸ Consumer ì°¨ë‹¨ì„ ë°©ì§€í•©ë‹ˆë‹¤.

**ì„¤ì • (KafkaConfig.java):**

```java
DefaultErrorHandler errorHandler = new DefaultErrorHandler(
    new DeadLetterPublishingRecoverer(kafkaTemplate),
    new FixedBackOff(1000L, 3L)  // 1ì´ˆ ê°„ê²©, ìµœëŒ€ 3íšŒ ì¬ì‹œë„
);
factory.setCommonErrorHandler(errorHandler);
```

**íë¦„:**
```
ë©”ì‹œì§€ ì²˜ë¦¬ ì‹¤íŒ¨ â†’ 1ì´ˆ í›„ ì¬ì‹œë„ (1íšŒ)
                 â†’ 1ì´ˆ í›„ ì¬ì‹œë„ (2íšŒ)
                 â†’ 1ì´ˆ í›„ ì¬ì‹œë„ (3íšŒ)
                 â†’ payment-completed.DLT í† í”½ìœ¼ë¡œ ì´ë™
```

**DLT ë©”ì‹œì§€ ëª¨ë‹ˆí„°ë§:**
```bash
# DLT í† í”½ì˜ ë©”ì‹œì§€ í™•ì¸
docker exec -it kafka kafka-console-consumer \
    --bootstrap-server localhost:9092 \
    --topic payment-completed.DLT \
    --from-beginning
```

---

### ì´ë²¤íŠ¸ íë¦„ ìš”ì•½

```
ì‚¬ìš©ì ê²°ì œ ìš”ì²­
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ProcessPaymentUseCase                                         â”‚
â”‚  1. í¬ì¸íŠ¸ ì°¨ê°                                               â”‚
â”‚  2. ê²°ì œ ì •ë³´ ì €ì¥                                            â”‚
â”‚  3. ì˜ˆì•½ í™•ì •                                                 â”‚
â”‚  4. Outboxì— PaymentCompletedEvent ì €ì¥                       â”‚
â”‚     â””â”€â”€ ë™ì¼ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ì›ìì  ì €ì¥                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“ (1ì´ˆ ì´ë‚´)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OutboxPublisher (ìŠ¤ì¼€ì¤„ëŸ¬)                                    â”‚
â”‚  - PENDING ìƒíƒœ ì´ë²¤íŠ¸ ì¡°íšŒ                                   â”‚
â”‚  - Kafkaë¡œ ë°œí–‰                                               â”‚
â”‚  - PUBLISHEDë¡œ ìƒíƒœ ë³€ê²½                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Kafka Topic: payment-completed                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PaymentCompletedConsumer                                      â”‚
â”‚  - ë©”ì‹œì§€ ìˆ˜ì‹                                                 â”‚
â”‚  - í† í° ë§Œë£Œ ì²˜ë¦¬ (queueToken.expire())                       â”‚
â”‚  - ìˆ˜ë™ ACK                                                   â”‚
â”‚                                                               â”‚
â”‚  ì‹¤íŒ¨ ì‹œ: DLTë¡œ ì´ë™                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ§ª ë¶€í•˜ í…ŒìŠ¤íŠ¸ (k6)

k6ë¥¼ ì‚¬ìš©í•œ HTTP ê¸°ë°˜ ë¶€í•˜ í…ŒìŠ¤íŠ¸ë¥¼ ì§€ì›í•©ë‹ˆë‹¤.

### ì„¤ì¹˜ ë° ì‹¤í–‰

```bash
# k6 ì„¤ì¹˜ (macOS)
brew install k6

# ì „ì²´ ë¶€í•˜ í…ŒìŠ¤íŠ¸
k6 run k6/load-test.js

# ëŒ€ê¸°ì—´ ë™ì‹œì„± í…ŒìŠ¤íŠ¸
k6 run k6/queue-concurrency-test.js
```

ìƒì„¸ ì‚¬ìš©ë²•ì€ [k6/README.md](k6/README.md) ì°¸ì¡°.

